name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Install Docker
      - name: Install Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            apt-transport-https \
            ca-certificates \
            curl \
            gnupg \
            lsb-release
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
            $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io

      # Configure permission to Docker
      - name: Configure Docker permissions
        run: |
          sudo usermod -aG docker $USER
          newgrp docker

      # Verify Docker installation
      - name: Verify Docker installation
        run: docker --version
      
      # Run a Docker command to verify it works
      - name: Verify Docker access
        run: docker ps

      # Download and install Kubernetes Minikube
      - name: Install Minikube
        run: |
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube
          rm minikube-linux-amd64

      # Start Minikube
      - name: Start Minikube
        run: |
          sudo minikube start --driver=docker --force

      # Install kubectl
      - name: Install kubectl
        run: sudo snap install kubectl --classic

      # Enable Ingress
      - name: Enable Ingress
        run: kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml

      # Apply Kubernetes deployment
      - name: Apply Kubernetes Deployment
        run: kubectl apply -f cowsay/deployment.yaml 
        
      - name: Apply Kubernetes Service
        run: kubectl apply -f cowsay/service.yaml 
        
      - name: Apply Kubernetes Ingress
        run: kubectl apply -f cowsay/cow-ingress.yaml 

      # Get Deployment
      - name: Get Deployment
        run: |
          sleep 60 # wait for the ingress to be ready
          curl $(minikube ip)/cowsay

      - name: Add other actions
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.
